{% extends "base.html" %}

{% block title %}Log Details - Proof Logger{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2>Log Details</h2>
        <div>
            <div style="display: inline-block; margin-right: 8px;">
                <select onchange="if(this.value) window.location.href=this.value" class="button secondary" style="padding: 8px 12px; border: none; cursor: pointer;">
                    <option value="">üì§ Export Options</option>
                    <option value="{{ url_for('export_log_text', log_id=log.id) }}">üìÑ Text File</option>
                    <option value="{{ url_for('export_log_pdf', log_id=log.id) }}">üìã PDF Report</option>
                    <option value="{{ url_for('export_log_zip', log_id=log.id) }}">üì¶ Complete Evidence Package</option>
                </select>
            </div>
            <a href="{{ url_for('dashboard') }}" class="button secondary">Back</a>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field">
            <label>Method:</label>
            <p>{{ log.method }}</p>
        </div>
        
        <div class="field">
            <label>Recipient:</label>
            <p>{{ log.recipient }}</p>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field">
            <label>Date/Time:</label>
            <p class="meta">{{ log.timestamp }}</p>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field">
            <label>Description:</label>
            <p>{{ log.description }}</p>
        </div>
    </div>
    
    {% if log.notes %}
    <div class="form-row">
        <div class="field">
            <label>Notes:</label>
            <p>{{ log.notes }}</p>
        </div>
    </div>
    {% endif %}
    
    {% if log.file_path %}
    <div class="form-row">
        <div class="field">
            <label>Evidence File:</label>
            <p><a href="{{ url_for('uploaded_file', filename=log.file_path) }}" target="_blank">üìÑ Download File</a></p>
        </div>
    </div>
    {% endif %}
    
    {% if log.audio_path %}
    <div class="form-row">
        <div class="field">
            <label>Audio Recording:</label>
            <audio controls style="width: 100%; margin-top: 8px;">
                <source src="{{ url_for('uploaded_file', filename=log.audio_path) }}" type="audio/webm">
                <source src="{{ url_for('uploaded_file', filename=log.audio_path) }}" type="audio/wav">
                Your browser does not support audio playback.
            </audio>
        </div>
    </div>
    {% endif %}
    
    {% if log.transcript %}
    <div class="form-row">
        <div class="field">
            <label>Transcript:</label>
            <div class="card" style="background: rgba(255,255,255,0.02); padding: 12px;">
                <p>{{ log.transcript }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="form-row">
        <div class="field">
            <label>Verification Hash:</label>
            <div class="card" style="background: rgba(255,255,255,0.02); padding: 12px;">
                <code style="font-family: monospace; font-size: 0.85rem; color: var(--accent);">{{ log.verification_hash }}</code>
            </div>
            <p class="meta" style="margin-top: 4px;">This SHA256 hash can be used to verify the integrity of this log entry.</p>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field">
            <label>Blockchain Timestamp:</label>
            <div class="card" style="background: rgba(255,255,255,0.02); padding: 12px;">
                {% if log.ots_status == 'confirmed' %}
                    <p style="color: var(--accent); margin-bottom: 8px;">‚úì <strong>Confirmed on Bitcoin Blockchain</strong></p>
                    <p class="meta">Timestamp created: {{ log.ots_created_at[:16] if log.ots_created_at else 'Unknown' }}</p>
                    <p class="meta">Blockchain confirmed: {{ log.ots_confirmed_at[:16] if log.ots_confirmed_at else 'Unknown' }}</p>
                {% elif log.ots_status == 'pending' %}
                    <p style="color: #fbbf24; margin-bottom: 8px;">‚è≥ <strong>Pending Blockchain Confirmation</strong></p>
                    <p class="meta">Timestamp created: {{ log.ots_created_at[:16] if log.ots_created_at else 'Unknown' }}</p>
                    <p class="meta">Waiting for Bitcoin blockchain confirmation (usually 1-6 hours)</p>
                    <a href="{{ url_for('check_timestamp', log_id=log.id) }}" class="button secondary" style="margin-top: 8px;">Check Status</a>
                {% elif log.ots_status == 'failed' %}
                    <p style="color: #ef4444; margin-bottom: 8px;">‚úó <strong>Timestamp Failed</strong></p>
                    <p class="meta">There was an issue with the blockchain timestamp</p>
                {% else %}
                    <p style="color: var(--muted); margin-bottom: 8px;">- <strong>No Blockchain Timestamp</strong></p>
                    <p class="meta">This log was created before blockchain timestamping was enabled</p>
                {% endif %}
                
                {% if log.ots_info %}
                <details style="margin-top: 12px;">
                    <summary style="cursor: pointer; color: var(--accent);">View Technical Details</summary>
                    <pre style="background: rgba(0,0,0,0.3); padding: 8px; margin-top: 8px; font-size: 0.8rem; overflow-x: auto;">{{ log.ots_info }}</pre>
                </details>
                {% endif %}
            </div>
            <p class="meta" style="margin-top: 4px;">
                Blockchain timestamps provide cryptographic proof that this data existed at a specific time, 
                anchored to the Bitcoin blockchain via <a href="https://opentimestamps.org" target="_blank" style="color: var(--accent);">OpenTimestamps</a>.
            </p>
        </div>
    </div>
    
    {% if log.method.lower() == 'email' %}
    <div class="form-row">
        <div class="field">
            <label>Email Verification:</label>
            <div class="card" style="background: rgba(255,255,255,0.02); padding: 12px;">
                {% if log.email_verification_status == 'verified' %}
                    <p style="color: var(--accent); margin-bottom: 8px;">‚úì <strong>Email Fully Verified</strong></p>
                    <p class="meta">DKIM signature and SPF record verified successfully</p>
                {% elif log.email_verification_status == 'partial' %}
                    <p style="color: #fbbf24; margin-bottom: 8px;">‚ö† <strong>Email Partially Verified</strong></p>
                    <p class="meta">Some verification checks passed, but not all</p>
                {% elif log.email_verification_status == 'failed' %}
                    <p style="color: #ef4444; margin-bottom: 8px;">‚úó <strong>Email Verification Failed</strong></p>
                    <p class="meta">Email authenticity could not be verified</p>
                {% else %}
                    <p style="color: var(--muted); margin-bottom: 8px;">- <strong>Email Not Verified</strong></p>
                    <p class="meta">Email verification has not been performed</p>
                    {% if log.file_path %}
                    <form method="POST" action="{{ url_for('verify_email_metadata', log_id=log.id) }}" style="margin-top: 8px;">
                        <button type="submit" class="button secondary">üîç Verify Email Now</button>
                    </form>
                    {% endif %}
                {% endif %}
                
                {% if log.email_metadata %}
                <details style="margin-top: 12px;">
                    <summary style="cursor: pointer; color: var(--accent);">View Email Verification Details</summary>
                    <div style="margin-top: 12px;">
                        
                        <!-- Verification Summary -->
                        <div style="margin-bottom: 16px;">
                            <h4 style="margin-bottom: 8px; color: var(--accent);">Verification Summary</h4>
                            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px;">
                                <p><strong>DKIM Signature:</strong> 
                                    {% if log.email_metadata.dkim_valid %}
                                        <span style="color: var(--accent);">‚úì Valid</span>
                                    {% else %}
                                        <span style="color: #ef4444;">‚úó Invalid/Missing</span>
                                    {% endif %}
                                </p>
                                <p><strong>SPF Record:</strong> 
                                    {% if log.email_metadata.spf_valid %}
                                        <span style="color: var(--accent);">‚úì Valid</span>
                                    {% else %}
                                        <span style="color: #ef4444;">‚úó Invalid/Missing</span>
                                    {% endif %}
                                </p>
                                <p><strong>Risk Level:</strong> 
                                    {% if log.email_metadata.risk_level == 'low' %}
                                        <span style="color: var(--accent);">Low</span>
                                    {% elif log.email_metadata.risk_level == 'medium' %}
                                        <span style="color: #fbbf24;">Medium</span>
                                    {% elif log.email_metadata.risk_level == 'high' %}
                                        <span style="color: #ef4444;">High</span>
                                    {% else %}
                                        <span style="color: var(--muted);">Unknown</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Email Headers -->
                        {% if log.email_metadata.headers %}
                        <div style="margin-bottom: 16px;">
                            <h4 style="margin-bottom: 8px; color: var(--accent);">Key Email Headers</h4>
                            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; font-family: monospace; font-size: 0.85rem;">
                                {% if log.email_metadata.headers.from %}<p><strong>From:</strong> {{ log.email_metadata.headers.from }}</p>{% endif %}
                                {% if log.email_metadata.headers.to %}<p><strong>To:</strong> {{ log.email_metadata.headers.to }}</p>{% endif %}
                                {% if log.email_metadata.headers.subject %}<p><strong>Subject:</strong> {{ log.email_metadata.headers.subject }}</p>{% endif %}
                                {% if log.email_metadata.headers.date %}<p><strong>Date:</strong> {{ log.email_metadata.headers.date }}</p>{% endif %}
                                {% if log.email_metadata.headers.message_id %}<p><strong>Message-ID:</strong> {{ log.email_metadata.headers.message_id }}</p>{% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Security Analysis -->
                        {% if log.email_metadata.security_analysis and log.email_metadata.security_analysis.warnings %}
                        <div style="margin-bottom: 16px;">
                            <h4 style="margin-bottom: 8px; color: #fbbf24;">Security Warnings</h4>
                            <div style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid #fbbf24; padding: 12px;">
                                {% for warning in log.email_metadata.security_analysis.warnings %}
                                <p style="margin-bottom: 4px;">‚ö† {{ warning }}</p>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <p class="meta" style="margin-top: 12px;">
                            Email verification performed on: {{ log.email_metadata.created_at[:16] if log.email_metadata.created_at else 'Unknown' }}
                        </p>
                    </div>
                </details>
                {% endif %}
            </div>
            <p class="meta" style="margin-top: 4px;">
                Email verification checks DKIM signatures, SPF records, and other security indicators to validate email authenticity and detect potential spoofing or tampering.
            </p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
